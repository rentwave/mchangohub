name: Deploy Mchangohub to Master

on:
  push:
    branches:
      - master

jobs:
  pre-build:
    name: Pre-Build Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Dockerfile
        run: |
          echo "üîç Validating Dockerfile..."
          docker run --rm -i hadolint/hadolint < Dockerfile || true

  build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: pre-build
    outputs:
      backend_tag: ${{ steps.vars.outputs.backend_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract git commit hash
        id: vars
        run: |
          BACKEND_TAG=master-$(git rev-parse --short HEAD)-$(date +%s)
          echo "backend_tag=$BACKEND_TAG" >> $GITHUB_OUTPUT

      - name: Build and Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: osiru/mchangohub:${{ steps.vars.outputs.backend_tag }}

  deploy:
    name: Deploy to Master Server
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Mchangohub Master
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.MVPM_SERVER_IP }}
          username: ${{ secrets.MVPM_SSH_USER }}
          port: 22
          key: ${{ secrets.MVPM_PASSWORD_SSH_KEY }}
          timeout: 120s
          script: |
            set -euo pipefail

            echo "=== System Health Check ==="

            echo "Server architecture:"
            uname -m
            arch

            echo "Available disk space:"
            df -h /srv/apps/live/mchangohub

            echo "Available memory:"
            free -h

            echo "Docker system info:"
            docker --version
            docker info --format "{{.Architecture}}" || echo "Could not get Docker architecture"

            echo "=== Deploying Mchangohub to Master ==="
            cd /srv/apps/live/mchangohub
            git reset --hard
            git clean -fd
            git pull origin master

            LATEST_TAG="${{ needs.build.outputs.backend_tag }}"
            echo "Using Docker tag: $LATEST_TAG"

            echo "Updating .env file..."
            {
              echo "BACKEND_TAG=$LATEST_TAG"
              echo "DEPLOY_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)"
              echo "GIT_COMMIT=${{ github.sha }}"
            } > .env

            echo "Pulling latest Docker image..."
            docker pull osiru/mchangohub:$LATEST_TAG

            echo "Restarting containers..."
            docker compose down --remove-orphans
            docker compose up -d --build --force-recreate

            echo "Deployment completed successfully ‚úÖ"

  clean:
    name: Clean Docker Cache
    needs: [build, deploy]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: always()
    steps:
      - name: Clean Docker cache on server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.MVPM_SERVER_IP }}
          username: ${{ secrets.MVPM_SSH_USER }}
          port: 22
          key: ${{ secrets.MVPM_PASSWORD_SSH_KEY }}
          timeout: 120s
          script: |
            set -euo pipefail
            echo "üßπ Cleaning up Docker..."

            # Keep only the 3 most recent mchangohub images
            docker images osiru/mchangohub --format "table {{.Repository}}:{{.Tag}}\t{{.CreatedAt}}" | \
              tail -n +2 | sort -k2 -r | tail -n +4 | awk '{print $1}' | \
              xargs -r docker rmi || true

            docker image prune -f
            docker builder prune -f
            docker system prune -f
            docker volume prune -f

            echo "‚úÖ Docker cleanup complete"
